<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Validador QR - Orbit</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; text-align: center; }
    #result { margin-top: 1rem; font-size: 1.2rem; font-weight: bold; }
    input, button, textarea { margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
    .ok { color: green; }
    .used { color: orange; }
    .invalid { color: red; }
  </style>
</head>
<body>
  <h2> Validador de Entradas QR</h2>

  <textarea id="codeInput" placeholder="C√≥digos v√°lidos, uno por l√≠nea"></textarea>
  <button onclick="loadCodes()"> Cargar c√≥digos v√°lidos</button>

  <button onclick="startScanner()"> Iniciar esc√°ner</button>
  <button onclick="stopScanner()"> Detener esc√°ner</button>
  <button onclick="clearUsedCodes()"> Borrar c√≥digos usados</button>

  <div id="reader" style="width: 300px; margin: auto; margin-top: 1rem;"></div>
  <div id="result">Esperando escaneo...</div>

  <script>
    let validCodes = new Set();
    let usedCodes = new Set(JSON.parse(localStorage.getItem('usedCodes') || '[]'));
    let qrScanner;

    function loadCodes() {
      const lines = document.getElementById('codeInput').value.split('\n').map(l => l.trim()).filter(l => l);
      validCodes = new Set(lines);
      document.getElementById('result').innerText = "‚úÖ C√≥digos cargados: " + validCodes.size;
      document.getElementById('result').className = 'ok';
    }

    function saveUsedCodes() {
      localStorage.setItem('usedCodes', JSON.stringify([...usedCodes]));
    }

    function clearUsedCodes() {
      if (confirm("¬øSeguro que quer√©s borrar los c√≥digos escaneados?")) {
        localStorage.removeItem('usedCodes');
        usedCodes = new Set();
        document.getElementById('result').innerText = "üßπ Lista de c√≥digos usados borrada.";
        document.getElementById('result').className = '';
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      const resultEl = document.getElementById('result');

      if (validCodes.has(decodedText)) {
        if (usedCodes.has(decodedText)) {
          resultEl.innerText = `‚ö†Ô∏è C√≥digo ${decodedText} ya fue usado`;
          resultEl.className = 'used';
        } else {
          resultEl.innerText = `‚úÖ Entrada v√°lida: ${decodedText}`;
          resultEl.className = 'ok';
          usedCodes.add(decodedText);
          saveUsedCodes();
        }
      } else {
        resultEl.innerText = `‚ùå C√≥digo inv√°lido: ${decodedText}`;
        resultEl.className = 'invalid';
      }
    }

    function startScanner() {
      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        (errorMessage) => {
          console.warn("Escaneo fallido: ", errorMessage);
        }
      ).catch(err => {
        document.getElementById('result').innerText = "‚ùå Error al iniciar la c√°mara: " + err;
        document.getElementById('result').className = 'invalid';
      });
    }

    function stopScanner() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          document.getElementById('result').innerText = "Esc√°ner detenido.";
          document.getElementById('result').className = '';
        }).catch(err => {
          console.error("Error al detener el esc√°ner: ", err);
        });
      }
    }
  </script>
</body>
</html>

