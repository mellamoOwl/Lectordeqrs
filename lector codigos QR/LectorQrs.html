<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Validador QR - Fiesta</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; text-align: center; }
    #result { margin-top: 1rem; font-size: 1.2rem; font-weight: bold; }
    input, button, textarea { margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
    .ok { color: green; }
    .used { color: orange; }
    .invalid { color: red; }
  </style>
</head>
<body>
  <h2>ğŸ‰ Validador de Entradas QR</h2>

  <textarea id="codeInput" placeholder="CÃ³digos vÃ¡lidos, uno por lÃ­nea"></textarea>
  <button onclick="loadCodes()">Cargar cÃ³digos vÃ¡lidos</button>

  <button onclick="startScanner()">ğŸ“· Iniciar escÃ¡ner</button>
  <button onclick="stopScanner()">ğŸ›‘ Detener escÃ¡ner</button>

  <div id="reader" style="width: 300px; margin: auto; margin-top: 1rem;"></div>
  <div id="result">Esperando escaneo...</div>

  <script>
    let validCodes = new Set();
    let usedCodes = new Set(JSON.parse(localStorage.getItem('usedCodes') || '[]'));
    let qrScanner;

    function loadCodes() {
      const lines = document.getElementById('codeInput').value.split('\n').map(l => l.trim()).filter(l => l);
      validCodes = new Set(lines);
      alert("CÃ³digos cargados: " + validCodes.size);
    }

    function saveUsedCodes() {
      localStorage.setItem('usedCodes', JSON.stringify([...usedCodes]));
    }

    function onScanSuccess(decodedText, decodedResult) {
      const resultEl = document.getElementById('result');

      if (validCodes.has(decodedText)) {
        if (usedCodes.has(decodedText)) {
          resultEl.innerText = `âš ï¸ CÃ³digo ${decodedText} ya fue usado`;
          resultEl.className = 'used';
        } else {
          resultEl.innerText = `âœ… Entrada vÃ¡lida: ${decodedText}`;
          resultEl.className = 'ok';
          usedCodes.add(decodedText);
          saveUsedCodes();
        }
      } else {
        resultEl.innerText = `âŒ CÃ³digo invÃ¡lido: ${decodedText}`;
        resultEl.className = 'invalid';
      }
    }

    function startScanner() {
      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        (errorMessage) => {
          console.warn("Escaneo fallido: ", errorMessage);
        }
      ).catch(err => {
        document.getElementById('result').innerText = "âŒ Error al iniciar la cÃ¡mara: " + err;
        document.getElementById('result').className = 'invalid';
      });
    }

    function stopScanner() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          document.getElementById('result').innerText = "EscÃ¡ner detenido.";
          document.getElementById('result').className = '';
        }).catch(err => {
          console.error("Error al detener el escÃ¡ner: ", err);
        });
      }
    }
  </script>
</body>
</html>
